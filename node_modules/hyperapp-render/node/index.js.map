{"version":3,"file":"index.js","sources":["../src/index.js","../src/node.js"],"sourcesContent":["const { isArray } = Array\nconst { hasOwnProperty } = Object.prototype\nconst styleNameCache = new Map()\nconst uppercasePattern = /[A-Z]/g\nconst msPattern = /^ms-/\n\n// https://www.w3.org/International/questions/qa-escapes#use\nconst escapeRegExp = /[\"&'<>]/\n\n// https://www.w3.org/TR/html/syntax.html#void-elements\nconst voidElements = new Set([\n  'area',\n  'base',\n  'br',\n  'col',\n  'embed',\n  'hr',\n  'img',\n  'input',\n  'link',\n  'meta',\n  'param',\n  'source',\n  'track',\n  'wbr',\n])\n\n// credits to https://github.com/component/escape-html\nexport function escapeHtml(value) {\n  const str = '' + value\n  if (typeof value === 'number') {\n    // better performance for safe values\n    return str\n  }\n\n  const match = escapeRegExp.exec(str)\n  if (!match) {\n    return str\n  }\n\n  let { index } = match\n  let lastIndex = 0\n  let out = ''\n\n  for (let escape = ''; index < str.length; index++) {\n    switch (str.charCodeAt(index)) {\n      case 34: // \"\n        escape = '&quot;'\n        break\n      case 38: // &\n        escape = '&amp;'\n        break\n      case 39: // '\n        escape = '&#39;' // shorter than \"&apos;\" and \"&#x27;\" plus supports HTML4\n        break\n      case 60: // <\n        escape = '&lt;'\n        break\n      case 62: // >\n        escape = '&gt;'\n        break\n      default:\n        continue\n    }\n\n    if (lastIndex !== index) {\n      out += str.substring(lastIndex, index)\n    }\n\n    lastIndex = index + 1\n    out += escape\n  }\n\n  return lastIndex !== index ? out + str.substring(lastIndex, index) : out\n}\n\n// credits to https://github.com/jorgebucaran/classcat\nexport function concatClassNames(value) {\n  if (typeof value === 'string' || typeof value === 'number') {\n    return value || ''\n  }\n\n  let out = ''\n  let delimiter = ''\n\n  if (isArray(value)) {\n    for (let i = 0; i < value.length; i++) {\n      const name = concatClassNames(value[i])\n      if (name !== '') {\n        out += delimiter + name\n        delimiter = ' '\n      }\n    }\n  } else {\n    for (const name in value) {\n      if (hasOwnProperty.call(value, name) && value[name]) {\n        out += delimiter + name\n        delimiter = ' '\n      }\n    }\n  }\n\n  return out\n}\n\n// \"backgroundColor\" => \"background-color\"\n// \"MozTransition\" => \"-moz-transition\"\n// \"msTransition\" => \"-ms-transition\"\nfunction hyphenateStyleName(styleName) {\n  return (\n    styleNameCache.get(styleName) ||\n    styleNameCache\n      .set(\n        styleName,\n        styleName\n          .replace(uppercasePattern, '-$&')\n          .toLowerCase()\n          .replace(msPattern, '-ms-'),\n      )\n      .get(styleName)\n  )\n}\n\nexport function stringifyStyles(style) {\n  let out = ''\n  let delimiter = ''\n\n  for (const name in style) {\n    if (hasOwnProperty.call(style, name)) {\n      const value = style[name]\n\n      if (value != null) {\n        if (name === 'cssText') {\n          out += delimiter + value\n        } else {\n          out += delimiter + hyphenateStyleName(name) + ':' + value\n        }\n        delimiter = ';'\n      }\n    }\n  }\n\n  return out\n}\n\n// https://www.w3.org/TR/html51/syntax.html#serializing-html-fragments\nfunction renderFragment(name, props, children, stack) {\n  let out = ''\n  let footer = ''\n\n  if (name) {\n    out += '<' + name\n\n    for (let prop in props) {\n      if (hasOwnProperty.call(props, prop)) {\n        let value = props[prop]\n\n        if (\n          value != null &&\n          prop !== 'key' &&\n          prop !== 'innerHTML' &&\n          prop !== '__source' && // babel-plugin-transform-react-jsx-source\n          !(prop[0] === 'o' && prop[1] === 'n')\n        ) {\n          if (prop === 'class' || prop === 'className') {\n            prop = 'class'\n            value = concatClassNames(value) || false\n          } else if (prop === 'style' && value && typeof value === 'object') {\n            value = stringifyStyles(value) || false\n          }\n\n          if (value !== false) {\n            out += ' ' + prop\n\n            if (value !== true) {\n              out += '=\"' + escapeHtml(value) + '\"'\n            }\n          }\n        }\n      }\n    }\n\n    if (voidElements.has(name)) {\n      out += '/>'\n    } else {\n      out += '>'\n      footer = '</' + name + '>'\n    }\n  }\n\n  const { innerHTML } = props\n\n  if (innerHTML != null) {\n    out += innerHTML\n  }\n\n  if (children.length > 0) {\n    stack.push({\n      childIndex: 0,\n      children,\n      footer,\n    })\n  } else {\n    out += footer\n  }\n\n  return out\n}\n\nfunction resolveNode(node, state, actions) {\n  if (typeof node === 'function') {\n    return resolveNode(node(state, actions), state, actions)\n  }\n\n  return node\n}\n\nexport function renderer(view, state, actions) {\n  const stack = [\n    {\n      childIndex: 0,\n      children: [view],\n      footer: '',\n    },\n  ]\n  let end = false\n\n  return (bytes) => {\n    if (end) {\n      return null\n    }\n\n    let out = ''\n\n    while (out.length < bytes) {\n      if (stack.length === 0) {\n        end = true\n        break\n      }\n\n      const frame = stack[stack.length - 1]\n\n      if (frame.childIndex >= frame.children.length) {\n        out += frame.footer\n        stack.pop()\n      } else {\n        const node = resolveNode(frame.children[frame.childIndex++], state, actions)\n\n        if (node != null && typeof node !== 'boolean') {\n          if (isArray(node)) {\n            stack.push({\n              childIndex: 0,\n              children: node,\n              footer: '',\n            })\n          } else if (node.type === 3) {\n            out += escapeHtml(node.name)\n          } else if (typeof node === 'object') {\n            out += renderFragment(\n              node.name || node.nodeName,\n              node.props || node.attributes,\n              node.children,\n              stack,\n            )\n          } else {\n            out += escapeHtml(node)\n          }\n        }\n      }\n    }\n\n    return out\n  }\n}\n\nexport function renderToString(view, state, actions) {\n  return renderer(view, state, actions)(Infinity)\n}\n","import { Readable } from 'stream'\nimport { renderer, renderToString } from './index'\n\nexport { renderToString }\n\nexport function renderToStream(view, state, actions) {\n  const read = renderer(view, state, actions)\n\n  // https://nodejs.org/api/stream.html\n  return new Readable({\n    read(size) {\n      try {\n        this.push(read(size))\n      } catch (err) {\n        this.emit('error', err)\n      }\n    },\n  })\n}\n"],"names":["isArray","Array","hasOwnProperty","Object","prototype","styleNameCache","Map","uppercasePattern","msPattern","escapeRegExp","voidElements","Set","escapeHtml","value","str","match","exec","index","lastIndex","out","escape","length","charCodeAt","substring","concatClassNames","delimiter","i","name","call","hyphenateStyleName","styleName","get","set","replace","toLowerCase","stringifyStyles","style","renderFragment","props","children","stack","footer","prop","has","innerHTML","push","childIndex","resolveNode","node","state","actions","renderer","view","end","bytes","frame","pop","type","nodeName","attributes","renderToString","Infinity","renderToStream","read","Readable","size","err","emit"],"mappings":"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"}